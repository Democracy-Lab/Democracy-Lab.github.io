<script>
  // ---- CONFIG ----
  const ORG = 'Democracy-Lab';
  const ORG_PAGES_BASE = 'https://democracy-lab.github.io'; // base org pages host

  // Fetch all org repos (handles pagination if >100)
  async function fetchAllRepos(url = `https://api.github.com/orgs/${ORG}/repos?per_page=100&type=public`) {
    const all = [];
    while (url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`GitHub API: ${res.status} ${res.statusText}`);
      const page = await res.json();
      all.push(...page);
      // parse Link header for pagination
      const link = res.headers.get('Link');
      const next = link && link.split(',').find(s => s.includes('rel="next"'));
      url = next ? next.split(';')[0].trim().slice(1, -1) : null;
    }
    return all;
  }

  // Construct org Pages URL for a repo
  function pagesUrl(repo) {
    if (repo.name.toLowerCase() === `${ORG.toLowerCase()}.github.io`) {
      return `${ORG_PAGES_BASE}/`;
    }
    return `${ORG_PAGES_BASE}/${encodeURIComponent(repo.name)}/`;
  }

  function fmtDate(iso) {
    try { return new Date(iso).toLocaleString(); } catch { return iso; }
  }

  function render(list) {
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    grid.innerHTML = '';
    if (!list.length) { empty.style.display = ''; return; }
    empty.style.display = 'none';

    for (const r of list) {
      const site = pagesUrl(r);

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>
          <a href="${site}" target="_blank" rel="noopener" style="color:#67b7ff;text-decoration:none;">
            ${r.name}
          </a>
        </h3>
        <div class="meta">${r.description ? r.description : ''}</div>
        <div class="meta">Updated: ${fmtDate(r.updated_at)}</div>
        <div class="links">
          <a href="${site}" target="_blank" rel="noopener">View site</a>
          <a href="${r.html_url}" target="_blank" rel="noopener">Repo</a>
        </div>
      `;

      // Make the whole card open the site when clicked (but not when clicking an inner link)
      card.style.cursor = 'pointer';
      card.addEventListener('click', (e) => {
        if (!(e.target instanceof HTMLAnchorElement)) {
          window.open(site, '_blank', 'noopener');
        }
      });

      grid.appendChild(card);
    }
  }

  function filterSort(repos) {
    const q = document.getElementById('q').value.toLowerCase().trim();
    const sort = document.getElementById('sort').value;

    let list = repos;
    if (q) {
      list = repos.filter(r =>
        (r.name && r.name.toLowerCase().includes(q)) ||
        (r.description && r.description.toLowerCase().includes(q))
      );
    }

    if (sort === 'name') {
      list.sort((a,b) => a.name.localeCompare(b.name));
    } else {
      list.sort((a,b) => new Date(b.updated_at) - new Date(a.updated_at));
    }
    render(list);
  }

  (async function init() {
    try {
      const repos = await fetchAllRepos();
      // Only show repos with Pages enabled OR the org root repo
      const withPages = repos.filter(r =>
        r.has_pages || r.name.toLowerCase() === `${ORG.toLowerCase()}.github.io`
      );
      window.__REPOS__ = withPages;
      filterSort(withPages);

      document.getElementById('q').addEventListener('input', () => filterSort(window.__REPOS__));
      document.getElementById('sort').addEventListener('change', () => filterSort(window.__REPOS__));
    } catch (err) {
      document.getElementById('grid').innerHTML =
        `<div class="empty">Error loading list: ${err.message}</div>`;
    }
  })();
</script>

