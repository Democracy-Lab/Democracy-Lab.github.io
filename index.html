<script>
  // ===== Configuration =====
  const ORG = 'Democracy-Lab';
  const ORG_PAGES_BASE = 'https://democracy-lab.github.io';
  const SHOW_ALL = true;        // true = show all public repos immediately; false = only those with Pages
  const AUTO_REFRESH_MS = 120000; // 2 minutes; set to 0 to disable auto-refresh

  // Build the expected Pages URL for a repo (works for org project pages)
  function pagesUrl(repoName) {
    if (repoName.toLowerCase() === `${ORG.toLowerCase()}.github.io`) return `${ORG_PAGES_BASE}/`;
    return `${ORG_PAGES_BASE}/${encodeURIComponent(repoName)}/`;
  }

  // Fetch all public repos with pagination; bust caches aggressively
  async function fetchAllRepos(url = `https://api.github.com/orgs/${ORG}/repos?per_page=100&type=public&ts=${Date.now()}`) {
    const all = [];
    while (url) {
      const res = await fetch(url, {
        cache: 'no-store',
        headers: { 'Accept': 'application/vnd.github+json' }
      });
      if (!res.ok) throw new Error(`GitHub API: ${res.status} ${res.statusText}`);
      const page = await res.json();
      all.push(...page);

      const link = res.headers.get('Link');
      const next = link && link.split(',').find(s => s.includes('rel="next"'));
      url = next ? next.split(';')[0].trim().slice(1, -1) + `&ts=${Date.now()}` : null;
    }
    return all;
  }

  function fmtDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }

  function render(list) {
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    grid.innerHTML = '';
    if (!list.length) { empty.style.display = ''; return; }
    empty.style.display = 'none';

    for (const r of list) {
      const live = !!r.has_pages || r.name.toLowerCase() === `${ORG.toLowerCase()}.github.io`;
      const site = pagesUrl(r.name);

      const card = document.createElement('div');
      card.className = 'card';
      if (!live) card.style.opacity = 0.6;

      card.innerHTML = `
        <h3>
          <a href="${live ? site : r.html_url}" target="_blank" rel="noopener"
             style="color:#67b7ff;text-decoration:none;">
            ${r.name}
          </a>
        </h3>
        <div class="meta">${r.description ? r.description : ''}</div>
        <div class="meta">Updated: ${fmtDate(r.updated_at)}</div>
        <div class="links">
          ${live
            ? `<a href="${site}" target="_blank" rel="noopener">View site</a>`
            : `<span class="meta">Not deployed yet</span>`}
          <a href="${r.html_url}" target="_blank" rel="noopener">Repo</a>
        </div>
      `;

      // Make the whole card open (site if live, else repo) unless a link was clicked
      card.style.cursor = 'pointer';
      card.addEventListener('click', (e) => {
        if (!(e.target instanceof HTMLAnchorElement)) {
          window.open(live ? site : r.html_url, '_blank', 'noopener');
        }
      });

      grid.appendChild(card);
    }
  }

  function filterSort(repos) {
    const q = document.getElementById('q').value.toLowerCase().trim();
    const sort = document.getElementById('sort').value;

    let list = repos.slice();
    if (!SHOW_ALL) {
      list = list.filter(r => r.has_pages || r.name.toLowerCase() === `${ORG.toLowerCase()}.github.io`);
    }
    if (q) {
      list = list.filter(r =>
        (r.name && r.name.toLowerCase().includes(q)) ||
        (r.description && r.description.toLowerCase().includes(q))
      );
    }
    if (sort === 'name') list.sort((a,b) => a.name.localeCompare(b.name));
    else list.sort((a,b) => new Date(b.updated_at) - new Date(a.updated_at));

    render(list);
  }

  async function loadAndRender() {
    const btn = document.getElementById('refreshBtn');
    if (btn) btn.disabled = true;

    try {
      const repos = await fetchAllRepos();
      window.__REPOS__ = repos;
      filterSort(repos);
    } catch (err) {
      document.getElementById('grid').innerHTML =
        `<div class="empty">Error loading list: ${err.message}</div>`;
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  function addRefreshButtonOnce() {
    if (document.getElementById('refreshBtn')) return;
    const toolbar = document.querySelector('.toolbar');
    const btn = document.createElement('button');
    btn.id = 'refreshBtn';
    btn.textContent = 'Refresh';
    btn.style.cssText =
      'padding:10px 12px;border-radius:10px;border:1px solid #30363d;background:#0d1117;color:#e6edf3;cursor:pointer;';
    btn.addEventListener('click', loadAndRender);
    toolbar.appendChild(btn);
  }

  (function start() {
    addRefreshButtonOnce();
    loadAndRender();
    document.getElementById('q').addEventListener('input', () => filterSort(window.__REPOS__ || []));
    document.getElementById('sort').addEventListener('change', () => filterSort(window.__REPOS__ || []));
    if (AUTO_REFRESH_MS > 0) setInterval(loadAndRender, AUTO_REFRESH_MS);
  })();
</script>


